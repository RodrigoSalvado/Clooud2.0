name: Deploy Bicep com Azure e VNet + Private Endpoints (Unificado)

on:
  push:
    branches:
      - main
      - master

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout do repositório
      - name: Checkout do repositório
        uses: actions/checkout@v4

      # 2. Login no Azure via OIDC
      - name: Login no Azure com Login v2 (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # 3. Mostrar contexto Azure (subscrição ativa, etc.)
      - name: Mostrar contexto Azure
        run: az account show

      # 4. Validar main.bicep
      - name: Validar main.bicep
        run: |
          az bicep install || true
          az bicep build --file templates/main.bicep

      # 5. Criar Resource Group se não existir
      - name: Criar Resource Group se não existir
        run: |
          az group create --name MiniProjetoCloud2.0 --location westeurope

      # 6. What-If Deploy (opcional) — usa mesmos parâmetros do deploy real
      - name: What-If Deploy (opcional)
        run: |
          az deployment group what-if \
            --resource-group MiniProjetoCloud2.0 \
            --template-file templates/main.bicep \
            --parameters \
              vnetName='myVNet' \
              addressPrefix='10.0.0.0/16' \
              privateSubnetName='private-subnet' \
              privateSubnetPrefix='10.0.1.0/24' \
              publicSubnetName='public-subnet' \
              publicSubnetPrefix='10.0.2.0/24' \
              storageAccountName='miniprojetostorage20' \
              containerName='reddit-posts' \
              enableBlobVersioning=true \
              blobSoftDeleteDays=7 \
              privateEndpointName='pe-storage' \
              planName='ASP-MiniProjetoCloud2.0' \
              skuTier='Basic' \
              skuName='B2' \
              capacity=1 \
              isLinux=true \
              webAppName='minhaapp-rodrig0salv' \
              imageName='rodrig0salv/minha-app:latest' \
              containerSasToken='' \
              containerRegistryUrl='' \
              containerRegistryUsername='' \
              containerRegistryPassword='' \
              createRoleAssignment=false \
            --only-show-errors

      # 7. Deploy Unificado via CLI direto
      - name: Deploy Unificado via az CLI
        run: |
          set -euxo pipefail
          echo "Iniciar deploy unificado..."
          az deployment group create \
            --resource-group MiniProjetoCloud2.0 \
            --template-file templates/main.bicep \
            --parameters \
              vnetName='myVNet' \
              addressPrefix='10.0.0.0/16' \
              privateSubnetName='private-subnet' \
              privateSubnetPrefix='10.0.1.0/24' \
              publicSubnetName='public-subnet' \
              publicSubnetPrefix='10.0.2.0/24' \
              storageAccountName='miniprojetostorage20' \
              containerName='reddit-posts' \
              enableBlobVersioning=true \
              blobSoftDeleteDays=7 \
              privateEndpointName='pe-storage' \
              planName='ASP-MiniProjetoCloud2.0' \
              skuTier='Basic' \
              skuName='B2' \
              capacity=1 \
              isLinux=true \
              webAppName='minhaapp-rodrig0salv' \
              imageName='rodrig0salv/minha-app:latest' \
              containerSasToken='' \
              containerRegistryUrl='' \
              containerRegistryUsername='' \
              containerRegistryPassword='' \
              createRoleAssignment=false \
            --only-show-errors

      # 8. Mostrar outputs do deploy
      - name: Mostrar outputs do deploy
        run: |
          DEPLOY_NAME=$(az deployment group list --resource-group MiniProjetoCloud2.0 --query '[0].name' -o tsv)
          echo "Deployment name: $DEPLOY_NAME"
          az deployment group show \
            --resource-group MiniProjetoCloud2.0 \
            --name "$DEPLOY_NAME" \
            --query properties.outputs
